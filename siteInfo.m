% site specific script to load site information
% Oregon Vineyard August 2016

clear; close all force; clc;
%% --------------------------INPUTS----------------------------------------
%Scintillometer Data Root Dir
%Supplementary eddy covariance data file should exist in here
info.rootDir = 'D:\MY DOCUMENTS\Users\Alexei\Google Drive\UofU\Research\Experiments\Oregon_Vineyard\Data\Scintillometer';
info.ECFileName = 'ECData.mat';

%Save Directory
info.saveDir = 'D:\MY DOCUMENTS\Users\Alexei\Google Drive\UofU\Research\Experiments\Oregon_Vineyard\Data\Processed';

%Days per split file
    info.daysPerFile = 2;

%Scintillometer frequency [hz]
    info.freq = 1/60;
%Averaging Period in minutes
    info.avgPer = 30;
    info.ECavgPer = 30;
    
% Scintillometer GPS Coordinates [Zone, Northing, Easting]
    info.Coord_Rx = [10, 481388.50, 4963276.06];
    info.Coord_Tx = [10, 480773.9, 4963704.42];

%Enter Infrared Large Aperture Scintillometer information
    %wavelength
    info.LASwavelen = 880E-9; % -- [m]
    %Aperture
    info.LASaperture = 0.15/2; % -- [m]
    %Transmitter Height
    info.LAS_hTx = 5.48; % -- [m]
    %Receiver Height
    info.LAS_hRx = 4.85; % -- [m]

%Enter Microwave Scintillometer information
    %wavelength
    info.MWSwavelen = 1.86E-3; % -- [m]
    %Aperture
    info.MWSaperture = 0.3/2; % -- [m]
    %Transmitter Height AGL
    info.MWS_hTx = 5.01; % -- [m]
    %Receiver Height AGL
    info.MWS_hRx = 5.44; % -- [m]
    
%enter horizontal path perpendicular displacement (relative to LAS)
    %Receiver
    info.yRx = 0; % -- [m]
    %Transmiter
    info.yTx = 0; % -- [m]

%Path information
    %Number of points for path weighting function calculation
    info.N = 301; 
    %Elevation of Receiver and Transmitter Tower
    info.beamEle = [92.42, 85.13]; % -- [m]
    %elevation along path - NOTE: if flat one evelation ok, otherwise provide a vector of length N (from above) of elevation profile
    %Make sure end points match elevation measured at towers
    info.GroundEle = 3.2128+[89.2334372549020
        89.1347646369321
        89.2334372549020
        89.2334372549020
        89.1477783729075
        88.8775324077561
        88.4345822273254
        88.3156345098039
        88.1694374226035
        87.8934460873323
        87.6425824311290
        87.3978317647059
        87.3978317647059
        87.3978317647059
        87.3978317647059
        87.3978317647059
        87.3978317647059
        87.3978317647059
        87.3978317647059
        86.8304650866639
        86.4800290196078
        86.4800290196078
        86.4800290196078
        86.4800290196078
        86.4800290196078
        86.4800290196078
        86.3821301534944
        86.1312629961515
        85.8803958388085
        85.6295321826052
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.5622262745098
        85.3664285422830
        85.0433223711171
        84.6972907377056
        84.6444235294118
        84.6444235294118
        84.6444235294118
        84.6444235294118
        84.6444235294118
        84.4975752302417
        84.0244382239892
        83.7455479451108
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.6899078342363
        83.4390441780330
        83.1881770206900
        82.9373098633471
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.6007838240096
        82.3499166666667
        82.0990495093237
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.6462681288342
        81.3954009714912
        81.1445373152879
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        81.2913821133184
        81.8481858531204
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        82.0745765433652
        82.6313767820276
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.8277452000128
        83.2086096715246
        83.6817501789168
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.7266207843137
        83.6305180028265
        83.6161178155607
        83.2983123697827
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.8088180392157
        82.5698232463313
        82.0274196937950
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8720881333205
        81.5931978544422
        81.1200643493293
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.9732125490196
        80.5855348598032
        80.1238990972093
        80.0554098039216
        80.0521047281183
        79.8514544163753
        79.3999334461496
        79.1508238608970
        78.9968752505733
        78.6968976077510
        78.3024102019695
        77.9458506417144
        77.3619270743995
        77.0538267876539
        76.5738800648364
        76.3841988235294
        76.0721457501505
        75.5153420103485
        75.4663960784314
        75.1961956280951
        74.6699498349149
        74.3064580182079
        73.6671359186524
        73.6307905882353
        73.5468017498405
        73.4839422890652
        73.6307905882353
        73.6307905882353
        73.6307905882353
        73.8166345805164
        74.5485933333333
        74.9524287819058
        75.2461253802460
        76.0537892751118
        76.4462390176332
        76.8084249092611
        77.2085491498341
        77.4488498677976
        78.2565172638029
        78.7949610274266
        79.0458246836300
        79.2182102952037
        79.6051142325637
        79.9834543824080
        80.0554098039216
        80.2838416585661
        80.7790043341813
        80.9732125490196
        81.0331345536520
        81.3036220974372
        81.5544892547802
        81.8544633964628
        81.8910152941176
        81.8910152941176
        81.8910152941176
        81.8910152941176]; % -- [m]
    
%Spike Test
    info.spikeTest.windowSizeFraction = 1;
    info.spikeTest.maxRuns = 10;
    info.spikeTest.maxConsecutiveOutliers = 3;
    info.spikeTest.spikeDef = 3;
%% --------------------------CALCULATIONS----------------------------------

info.lambda = [info.LASwavelen, info.LASwavelen; info.LASwavelen, info.MWSwavelen; info.MWSwavelen, info.MWSwavelen];
info.R = [info.LASaperture, info.LASaperture; info.LASaperture, info.MWSaperture; info.MWSaperture, info.MWSaperture];

info.d_Tx = sqrt((0-info.yTx)^2+(info.LAS_hTx-info.MWS_hTx)^2);
info.d_Rx = sqrt((0-info.yRx)^2+(info.LAS_hRx-info.MWS_hRx)^2);
if info.MWS_hTx-info.LAS_hTx<0;     info.d_Tx = -info.d_Tx;     end
if info.MWS_hRx-info.LAS_hRx<0;     info.d_Rx = -info.d_Rx;     end

%Beam Length
info.L = sqrt((info.Coord_Rx(2)-info.Coord_Tx(2))^2+(info.Coord_Rx(3)-info.Coord_Tx(3))^2);

%Beam Orientation
info.BeamOrient = 270+acos((info.Coord_Rx(2)-info.Coord_Tx(2))/info.L)*180/pi;

% Beam tilt from Receiver to Transmitter
info.pathTilt_LAS = atan(((info.beamEle(2)+info.LAS_hTx)-(info.beamEle(1)+info.LAS_hRx))/info.L)*180/pi;
info.pathTilt_MWS = atan(((info.beamEle(2)+info.MWS_hTx)-(info.beamEle(1)+info.MWS_hRx))/info.L)*180/pi;

% Beam Height
tmp = linspace(0, info.L, info.N);
tmp2 = info.beamEle(1)+info.LAS_hRx+tmp*tan(info.pathTilt_LAS*pi/180);
info.Z_LAS = tmp2-info.GroundEle';

tmp2 = info.beamEle(1)+info.MWS_hRx+tmp*tan(info.pathTilt_MWS*pi/180);
info.Z_MWS = tmp2-info.GroundEle';

%data directory information
info.dirInfoOMS = dir([info.rootDir, filesep, 'Split']);

%load EC Data
EC_full = load([info.rootDir, filesep, info.ECFileName]);
%% ------------------------Check Inputs------------------------------------
if ~exist(info.rootDir, 'dir')
    error(['Scintillometer Directory <', info.rootDir, '> Does not exist. Check siteInfo.m']);
end

if ~exist(info.saveDir, 'dir')
    mkdir(info.saveDir);
end

%% -----------------------RUN Scint Process--------------------------------
run('UTSapp_MAIN.m');